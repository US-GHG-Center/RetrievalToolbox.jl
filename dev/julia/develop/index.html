<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Develop ¬∑ RetrievalToolbox.jl</title><meta name="title" content="Develop ¬∑ RetrievalToolbox.jl"/><meta property="og:title" content="Develop ¬∑ RetrievalToolbox.jl"/><meta property="twitter:title" content="Develop ¬∑ RetrievalToolbox.jl"/><meta name="description" content="Documentation for RetrievalToolbox.jl."/><meta property="og:description" content="Documentation for RetrievalToolbox.jl."/><meta property="twitter:description" content="Documentation for RetrievalToolbox.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">RetrievalToolbox.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Main</a></li><li><a class="tocitem" href="../../design/design/">Design</a></li><li><span class="tocitem">Concepts</span><ul><li><a class="tocitem" href="../../concepts/core_concepts/">Core Concepts</a></li><li><a class="tocitem" href="../../concepts/radiance/">Radiance</a></li><li><a class="tocitem" href="../../concepts/phasefunction/">Scattering Phasefunction</a></li></ul></li><li><span class="tocitem">Functions</span><ul><li><a class="tocitem" href="../../functions/state_vector_functions/">State Vector Functions</a></li><li><a class="tocitem" href="../../functions/atmosphere_functions/">Atmosphere Functions</a></li></ul></li><li><span class="tocitem">Types</span><ul><li><a class="tocitem" href="../../types/atmosphere_types/">Atmosphere Types</a></li><li><a class="tocitem" href="../../types/buffer_types/">Buffer Types</a></li><li><a class="tocitem" href="../../types/state_vector_types/">State Vector Types</a></li></ul></li><li><span class="tocitem">Working with Julia</span><ul><li class="is-active"><a class="tocitem" href>Develop</a><ul class="internal"><li><a class="tocitem" href="#Extending-RetrievalToolbox"><span>Extending RetrievalToolbox</span></a></li></ul></li><li><a class="tocitem" href="../dicts/">Dictionaries</a></li><li><a class="tocitem" href="../units/">Units</a></li></ul></li><li><span class="tocitem">Pitfalls</span><ul><li><a class="tocitem" href="../../pitfalls/pitfalls/">Pitfalls</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Working with Julia</a></li><li class="is-active"><a href>Develop</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Develop</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-develop-or-extend-RetrievalToolbox"><a class="docs-heading-anchor" href="#How-to-develop-or-extend-RetrievalToolbox">How to develop or extend RetrievalToolbox</a><a id="How-to-develop-or-extend-RetrievalToolbox-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-develop-or-extend-RetrievalToolbox" title="Permalink"></a></h1><p>Thanks to Julia&#39;s approach to user-defined types and functions that act on or use those types, it is very straightforward to extend the capabilities of RetrievalToolbox to users&#39; own needs, without having to alter the RetrievalToolbox library itself.</p><h2 id="Extending-RetrievalToolbox"><a class="docs-heading-anchor" href="#Extending-RetrievalToolbox">Extending RetrievalToolbox</a><a id="Extending-RetrievalToolbox-1"></a><a class="docs-heading-anchor-permalink" href="#Extending-RetrievalToolbox" title="Permalink"></a></h2><p>Users can extend RetrievalToolbox for use in their own projects by adding or overwriting its existing functions. If wanted, these new functions can seamlessly propagate into the overall flow of functions <em>within</em> RetrievalToolbox. The following section will provide some examples that can be used as guidance.</p><h3 id="Example-1:-A-user-function-that-involves-a-RetrievalToolbox-type"><a class="docs-heading-anchor" href="#Example-1:-A-user-function-that-involves-a-RetrievalToolbox-type">Example 1: A user function that involves a RetrievalToolbox type</a><a id="Example-1:-A-user-function-that-involves-a-RetrievalToolbox-type-1"></a><a class="docs-heading-anchor-permalink" href="#Example-1:-A-user-function-that-involves-a-RetrievalToolbox-type" title="Permalink"></a></h3><p>In this first example, we will simply create a new function to extend the functionality of RetrievalToolbox. This new function will make use of existing functions and types that RetrievalToolbox provides.</p><p>Let the following be the task at hand:</p><div class="admonition is-success" id="Task-ac9050786ba40d8b"><header class="admonition-header">Task<a class="admonition-anchor" href="#Task-ac9050786ba40d8b" title="Permalink"></a></header><div class="admonition-body"><p>We want to write a function which calculates the total, isotropic solar-induced fluorescence (SIF) emission into the half hemisphere (towards the sky). The function will take a <code>SIFRadiance</code> type as argument, and simply produce the integral over the spectral dimensions and the positive half space.</p></div></div><p>We start off by creating a <code>SIFradiance</code> object and just inspect the spectrally resolved isotropic radiance that it represents. Using the function <code>get_SIF_radiance</code>, we can simply obtain that emitted radiance for some given wavelength (or wavenumber).</p><pre><code class="language-julia hljs">using RetrievalToolbox; const RE = RetrievalToolbox
using Unitful
using Plots; default(titlefontsize=10, labelfontsize=8)

# Create the SIF object with 1e-7 W/m2/sr/¬µm at a reference wavelength of 740nm.
sif = RE.SIFRadiance(1.0e-7, u&quot;W/m^2/sr/Œºm&quot;, 740.0, u&quot;nm&quot;);

# Make a plot for sake of visualization
wl = collect(650.0u&quot;nm&quot;:1.0u&quot;nm&quot;:870u&quot;nm&quot;)
Plots.plot(
    wl,
    RE.get_SIF_radiance.(Ref(sif), wl),
    label=nothing, size=(400, 200)
)
xlabel!(&quot;Wavelength&quot;)
ylabel!(&quot;SIF radiance\n($(sif.radiance_unit))&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">GKS: cannot open display - headless operation mode active</code></pre><p><img src="../develop_fig1.png" alt="sif plot"/></p><p>To get the spectrally integrated value, we only need to sample this emitted radiance waveform in spectral space and integrate with some appropriate technique (trapezoidal integration is sufficient here). Further, we then multiply the spectrally integrated value with <span>$2\pi$</span> to take care of the integration of the half-space, which is equal to <span>$2\pi$</span> steradians. Also note how we use various units to make sure that we get the correct units for the final result in Watts per square meter.</p><p>The function only takes one argument, <code>sif</code>, which must be of the sub-type <code>AbstractSIFRadiance</code>, which RetrievalToolbox exports.</p><pre><code class="language-julia hljs">function SIF_integral(sif::T) where T&lt;:RE.AbstractSIFRadiance

    # Spectrally integrated value
    int_value = 0. * u&quot;W/m^2/sr&quot;
    for i in 2:length(sif.ww_waveform)

        # Simply sample the waveform data underlying
        # the `sif` object..
        ww1 = sif.ww_waveform[i]
        ww2 = sif.ww_waveform[i-1]

        v1 = RE.get_SIF_radiance(sif, ww1) * sif.radiance_unit
        v2 = RE.get_SIF_radiance(sif, ww2) * sif.radiance_unit

        int_value += 0.5 * (v1 + v2) * (ww1 - ww2)
    end

    # Integrate over half-space (2œÄ sr),
    # we have to &quot;manually&quot; set the units to W/m^2 since
    # `Unitful` likes to turn W into kg/m/s^2.
    return (int_value * (2*pi*u&quot;sr&quot;) |&gt; u&quot;W/m^2&quot;)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">SIF_integral (generic function with 1 method)</code></pre><p>And we finally call the function to test it:</p><pre><code class="language-julia hljs"># Amount emitted towards the sky per m^2 of surface area for the
# `sif` object defined above.
SIF_integral(sif)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">4.0279806188885494e-8 W m^-2</code></pre><p>Users can write a function like the above in a script, for example, and simply use it as needed in that particular <code>.jl</code> file. If users want something more lasting, since this might be a function they would use over and over again, they could write a new module and use that module in their applications:</p><pre><code class="language-julia hljs">module MyNewModule

    # import other module
    using RetrievalToolbox
    const RE = RetrievalToolbox

    export SIF_integral # Make this function available to users of `MyNewModule`

    # Add SIF function
    function SIF_integral(sif::T) where T&lt;:RE.AbstractSIFRadiance
        # [...] relevant code
    end

end</code></pre><p>In the example above, our function would be accessible via <code>MyNewModule.SIF_radiance</code>.</p><p>To summarize, we can easily add new functions that make use of existing RetrievalToolbox functions and thus extend the overall capability of the software library to meet our own specific needs. In this example, we do not need to change anything within RetrievalToolbox itself, we simple make use of the existing functions. Further, we can create new modules that provide our new function if we need to use them for many projects.</p><h3 id="Example-2:-A-new-user-type-that-is-part-of-the-existing-RetrievalToolbox-type-hierarchy"><a class="docs-heading-anchor" href="#Example-2:-A-new-user-type-that-is-part-of-the-existing-RetrievalToolbox-type-hierarchy">Example 2: A new user type that is part of the existing RetrievalToolbox type hierarchy</a><a id="Example-2:-A-new-user-type-that-is-part-of-the-existing-RetrievalToolbox-type-hierarchy-1"></a><a class="docs-heading-anchor-permalink" href="#Example-2:-A-new-user-type-that-is-part-of-the-existing-RetrievalToolbox-type-hierarchy" title="Permalink"></a></h3><p>A step up in complexity is the introduction of a new user type. For example, if some form of atmospheric constituent or atmospheric element is needed that is currently not supported in RetrievalToolbox.</p><p>In RetrievalToolbox, we have an existing type hierarchy that starts with <code>AbstractAtmosphereElement</code>, and then moves on to another abstract type. For example, the SIF object we have used in Example 1 is of type <code>SIFRadiance</code>, which itself is a type that belongs to the abstract type <code>AbstractSIFRadiance</code> that is an <code>AbstractAtmosphereElement</code>.</p><p>Below is a visual representation of the current type hierarchy for all <code>AbstractAtmosphereElements</code>.</p><pre><code class="language-julia hljs">using InteractiveUtils
using AbstractTrees
AbstractTrees.children(x::Type) = subtypes(x)
print_tree(RE.AbstractAtmosphereElement)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">AbstractAtmosphereElement
‚îú‚îÄ AbstractAerosolType
‚îÇ  ‚îú‚îÄ GaussAerosol
‚îÇ  ‚îî‚îÄ TriangleAerosol
‚îú‚îÄ AbstractRayleighScattering
‚îÇ  ‚îî‚îÄ RayleighScattering
‚îú‚îÄ AbstractSIFRadiance
‚îÇ  ‚îî‚îÄ SIFRadiance
‚îî‚îÄ GasAbsorber</code></pre><div class="admonition is-success" id="Task-a34a7edcd6f31905"><header class="admonition-header">Task<a class="admonition-anchor" href="#Task-a34a7edcd6f31905" title="Permalink"></a></header><div class="admonition-body"><p>A scenario that a user might face is the following. The currently implemented method to calculate the emitted SIF radiance is not exactly what some user wants, but instead prefers their own formulation. The task here is therefore to create a new, user-defined object that represents our own SIF, and then implement the appropriate functions that compute the radiance.</p></div></div><p>For the sake of simplicity, let us just assume our new SIF produces a constant radiance of <span>$1\mathrm{W}/\mathrm{m}^2/\mathrm{sr}/\mathrm{¬µm}$</span> between 700 nm and 750 nm. We start by defining our new type, which is similar to the <code>SIFRadiance</code> type found in <code>src/types/sif_types.jl</code>, however omits several fields: <code>radiance_at_reference</code> and <code>ww_reference</code> (no need to impose some spectrally dependent scaling), and <code>waveform</code> and <code>itp</code> fields (we have no need for the interpolation object that captures the shape of the SIF waveform). Also, we only allow wavelengths here (again, for simplicity). Our new SIF type shall be called <code>MySIFRadiance</code>:</p><pre><code class="language-julia hljs">mutable struct MySIFRadiance &lt;: RE.AbstractSIFRadiance

    radiance_unit::Unitful.Units
    ww_unit :: Unitful.LengthUnits
    ww_waveform :: Vector

end</code></pre><p>Along with the type definition, it is also important to define an external constructor function:</p><pre><code class="language-julia hljs">function MySIFRadiance(
    radiance_unit::Unitful.Units,
    ww_unit::Unitful.LengthUnits
)

    # Produce &quot;waveform&quot; grid
    ww_waveform = [700.0u&quot;nm&quot;, 750.0u&quot;nm&quot;] .|&gt; ww_unit

    return MySIFRadiance(
        radiance_unit,
        ww_unit,
        ww_waveform
    )

end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.MySIFRadiance</code></pre><p>With both these defined, we can create a new SIF object, which we shall call <code>new_sif</code>:</p><pre><code class="language-julia hljs">new_sif = MySIFRadiance(u&quot;W/m^2/sr/Œºm&quot;, u&quot;nm&quot;);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.MySIFRadiance(W Œºm^-1 m^-2 sr^-1, nm, Unitful.Quantity{Float64, ùêã, Unitful.FreeUnits{(nm,), ùêã, nothing}}[700.0 nm, 750.0 nm])</code></pre><p>Now, RetrievalToolbox provides a <code>get_SIF_radiance</code> function that we used earlier evaluate the SIF radiance at some wavelength or wavenumber. Let&#39;s try to use it here to get the SIF at 725 nm:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; RE.get_SIF_radiance(new_sif, 725.0u&quot;nm&quot;)</code><code class="nohighlight hljs ansi" style="display:block;">ERROR: MethodError: no method matching get_SIF_radiance(::Main.MySIFRadiance, ::Unitful.Quantity{Float64, ùêã, Unitful.FreeUnits{(nm,), ùêã, nothing}})
The function `get_SIF_radiance` exists, but no method is defined for this combination of argument types.

Closest candidates are:
  get_SIF_radiance(<span class="sgr91">::SIFRadiance</span>, ::Union{Unitful.Level{L, S, Unitful.Quantity{T, ùêã, U}} where {T, U, L, S}, Unitful.Level{L, S, Unitful.Quantity{T, ùêã^-1, U}} where {T, U, L, S}, Unitful.Quantity{T, ùêã} where T, Unitful.Quantity{T, ùêã^-1} where T})
<span class="sgr90">   @</span> <span class="sgr35">RetrievalToolbox</span> <span class="sgr90">~/work/RetrievalToolbox.jl/RetrievalToolbox.jl/src/<span class="sgr4">SIFRadiance.jl:9</span></span></code></pre><p>The above call fails: there is no <code>get_SIF_radiance</code> function that accepts a SIF object of type <code>MySIFRadiance</code>! This is very much intended behavior, since the <code>get_SIF_radiance</code> function that RetrievalToolbox provides only makes sense for <code>SIFRadiance</code> objects. We have to write our own! While generally we are free to choose the arguments for our own implementation, it is considered <strong>good practice</strong> to <strong>keep the same arguments</strong>. That way, our new user-defined function have a good chance of seamlessly integrating into function inside of RetrievalToolbox.</p><pre><code class="language-julia hljs">import RetrievalToolbox: get_SIF_radiance

function RetrievalToolbox.get_SIF_radiance(
    sif::MySIFRadiance, # Note that this is now `MySIFRadiance`
    ww::Unitful.Length
)

    if (ww &lt; sif.ww_waveform[1]) | (ww &gt; sif.ww_waveform[end])
        return 0.
    else
        return 1.0
    end

end</code></pre><p>Now that we have created a function that accepts our new SIF type <code>MySIFRadiance</code>, a call to <code>get_SIF_radiance</code> will use the correct method!</p><pre><code class="language-julia hljs">RE.get_SIF_radiance(new_sif, 725.0u&quot;nm&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1.0</code></pre><p>Further, any uses of <code>SIF_integral</code> that are invoked with objects of the new SIF type <code>MySIFRadiance</code> will themselves make calls to the correct <code>get_SIF_radiance</code>. <strong>This is an important part of the exercise!</strong> We did not have to make any adjustments to <code>SIF_integral</code> at all, since we kept the same function signature in our new implementation of <code>get_SIF_radiance</code>.</p><pre><code class="language-julia hljs">SIF_integral(new_sif)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.3141592653589793 W m^-2</code></pre><p>Here is a summary of the important steps when creating a new type that fits into the existing type hierarchy.</p><div class="admonition is-info" id="Summary-5d33809e0fbc4982"><header class="admonition-header">Summary<a class="admonition-anchor" href="#Summary-5d33809e0fbc4982" title="Permalink"></a></header><div class="admonition-body"><ol><li>Investigate the RetrievalToolbox type hierarchy to understand where your new type fits in best.</li><li>Write the new type definition, making sure that you understand which type fields are potentially needed by other functions, or if they can safely omitted if they serve no purpose for your new type.</li><li>Write all needed functions to implement the desired behavior for your new type  a. This requires knowing which functions may use your new type. The Julia function <code>methodswith</code> can be useful in finding that out. E.g. <code>methodswith(RE.SIFRadiance, RetrievalToolbox)</code> will list all functions that have at least one <code>SIFRadiance</code> function argument.</li><li>Run tests!</li></ol></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../types/state_vector_types/">¬´ State Vector Types</a><a class="docs-footer-nextpage" href="../dicts/">Dictionaries ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Thursday 13 November 2025 19:49">Thursday 13 November 2025</span>. Using Julia version 1.12.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
